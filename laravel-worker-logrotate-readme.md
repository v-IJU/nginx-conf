# Professional Log Management for Laravel Workers with logrotate

This guide explains the industry-standard method for managing and
rotating log files generated by a Laravel application worker running
under Supervisor.

------------------------------------------------------------------------

## The Problem: Unmanaged Log Files

When you configure Supervisor to run your Laravel queue worker, you also
specify a log file:

``` ini
[program:laravel-worker]
command=php /path/to/your/project/artisan queue:work
# ...
stdout_logfile=/path/to/your/project/storage/logs/worker.log
```

This `worker.log` file is critical for debugging, but it will grow
indefinitely. Over time, it can consume a massive amount of disk space,
potentially crashing your server.

------------------------------------------------------------------------

## The Solution: logrotate

The correct solution is not to disable logging or manually delete the
file.\
The professional solution is to use **logrotate**, a standard and highly
reliable utility built into virtually all Linux systems.

logrotate automates the process of:

-   **Rotating**: Archiving the current log file.\
-   **Compressing**: Compressing the archived logs to save space.\
-   **Managing**: Automatically deleting the oldest archives to prevent
    disk space from filling up.

------------------------------------------------------------------------

## Step 1: Create the logrotate Configuration File

You only need to create one simple configuration file. logrotate will
automatically find and use it.

Open a new file in the `/etc/logrotate.d/` directory using a text editor
like nano:

``` bash
sudo nano /etc/logrotate.d/laravel-worker
```

------------------------------------------------------------------------

## Step 2: Add the Configuration

Paste the following configuration into the file. This is a robust,
production-ready setup:

``` conf
/var/www/florist_multibranch/storage/logs/worker.log {

    # Rotate the log file once every day.
    daily

    # Keep 7 archives. After 7 days, the oldest compressed log is deleted.
    # You can change this to 'rotate 2' to only keep 2 days of logs.
    rotate 7

    # Compress the old log files with gzip to save disk space.
    # The archived file will be named something like worker.log.1.gz
    compress

    # Don't compress the most recent archive immediately. This is useful
    # if you need to quickly check yesterday's log without unzipping it.
    delaycompress

    # If the worker.log file is missing for any reason, don't produce an error.
    missingok

    # If the worker.log file is empty, do not rotate it.
    notifempty

    # THIS IS THE MOST IMPORTANT PART FOR SUPERVISOR.
    # Supervisor keeps the log file open. This command first copies the
    # contents to an archive, and THEN empties the original file.
    # This lets Supervisor keep writing without needing a restart.
    copytruncate
}
```

Save the file and exit the editor (in nano, press **Ctrl+X**, then
**Y**, then **Enter**).

------------------------------------------------------------------------

## Step 3: How it Works Automatically (No Action Needed)

You are now finished with the setup. You do not need to schedule
anything.

Your Linux server runs a **cron job every single day** (usually in the
early morning) that executes the logrotate program.\
This program automatically checks the `/etc/logrotate.d/` directory,
finds your `laravel-worker` configuration, and performs the rotation.

It is a **"set it and forget it"** system.

------------------------------------------------------------------------

## Understanding the Archive, Compression, and Deletion Cycle

A common question is: *"Doesn't `worker.log.1` also take up space?"*\
Yes, but logrotate manages this for you. Here's the lifecycle:

1.  **Rotation**: When logrotate runs, the current `worker.log` is
    copied to `worker.log.1`. A new, empty `worker.log` is created.\
2.  **Shifting**: On the next day, the existing `worker.log.1` is
    renamed to `worker.log.2`, and the new archive becomes
    `worker.log.1`.\
3.  **Compression**: After one day, the archives are compressed to save
    space (e.g., `worker.log.2` becomes `worker.log.2.gz`).\
4.  **Automatic Deletion**: The `rotate 7` directive tells logrotate to
    only keep 7 archives. When the 8th archive is about to be created,
    the oldest one (`worker.log.7.gz`) is automatically deleted.

This ensures that your log files are always available for a reasonable
period for debugging, but they will never fill up your server's disk.

------------------------------------------------------------------------

## (Optional) How to Verify Your Setup

You can test your configuration without waiting for the daily cron job.

### Dry Run (Safe Mode)

See what logrotate would do without making any changes:

``` bash
sudo logrotate --debug /etc/logrotate.conf
```

### Force Rotation

Run the rotation process immediately:

``` bash
sudo logrotate --force /etc/logrotate.conf
```

After forcing a rotation, you can check your `storage/logs` directory
and you will see the new `worker.log.1` archive file.

------------------------------------------------------------------------

âœ… You now have **professional, automated log management** for your
Laravel workers using Supervisor + logrotate.
